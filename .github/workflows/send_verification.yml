name: Send Verification Email

on:
  repository_dispatch:
    types: [send_verification]

jobs:
  send:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Send verification email
        env:
          GMAIL_USER: ${{ secrets.GMAIL_USER }}
          GMAIL_APP_PASSWORD: ${{ secrets.GMAIL_APP_PASSWORD }}
          TARGET_EMAIL: ${{ github.event.client_payload.email }}
          CONFIRM_URL: ${{ github.event.client_payload.confirm_url }}
        run: |
          python -c "
          import smtplib, os
          from email.message import EmailMessage

          gmail_user = os.environ['GMAIL_USER']
          gmail_pass = os.environ['GMAIL_APP_PASSWORD']
          to_email   = os.environ['TARGET_EMAIL']
          confirm_url = os.environ['CONFIRM_URL']

          html = f'''
          <div style=\"font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial,sans-serif;max-width:480px;margin:0 auto;padding:40px 20px;text-align:center;\">
            <h1 style=\"font-family:'Palatino Linotype','Book Antiqua',Palatino,serif;font-size:24px;color:#B31B1B;margin:0 0 24px 0;font-weight:600;\">
              Daily Dining Picks
            </h1>
            <p style=\"color:#444;font-size:16px;line-height:1.6;margin:0 0 32px 0;\">
              Please confirm your email address to start receiving daily recommendations for West Campus dining.
            </p>
            <div style=\"margin: 32px 0;\">
              <a href=\"{confirm_url}\"
                 style=\"display:inline-block;padding:12px 24px;border:1px solid #B31B1B;color:#B31B1B;text-decoration:none;border-radius:4px;font-weight:600;font-size:14px;text-transform:uppercase;letter-spacing:0.05em;\">
                Confirm Subscription
              </a>
            </div>
            <p style=\"color:#999;font-size:12px;margin:40px 0 0 0;font-style:italic;font-family:'Palatino Linotype',serif;\">
              If this wasn't you, please ignore this email.
            </p>
          </div>
          '''

          msg = EmailMessage()
          msg['Subject'] = 'Confirm: Campus Meal Pick Subscription'
          msg['From'] = gmail_user
          msg['To'] = to_email
          msg.set_content('Click this link to confirm: ' + confirm_url)
          msg.add_alternative(html, subtype='html')

          with smtplib.SMTP_SSL('smtp.gmail.com', 465, timeout=30) as smtp:
              smtp.login(gmail_user, gmail_pass)
              smtp.send_message(msg)

          print(f'Verification email sent to {to_email}')
          "
